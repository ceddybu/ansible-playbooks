---
- name: check if default mysql-libs is present
  command: /bin/rpm -q mysql-libs
  register: result
  ignore_errors: True

- name: default mysql-libs package is absent
  command: rpm -e mysql-libs --nodeps
  when: result|success

- name: mysql packages are present
  yum: state=present name={{ item }}
  with_items:
    - mysql55
    - mysql55-server
    - MySQL-python

- name: /var/lib/mysqltmp/ exists
  file: state=directory path=/var/lib/mysqltmp/ owner=mysql group=mysql

- name: /var/log/mysql/ exists
  file: state=directory path=/var/log/mysql/ owner=mysql group=mysql

- name: /etc/my.cnf is configured
  template: src=etc_my.cnf.j2 dest=/etc/my.cnf owner=root group=root mode=0644
  notify: restart mysqld

- name: mysqld service is started and enabled
  service: state=started name=mysqld enabled=yes

- name: root mysql user accounts exist
  mysql_user: state=present name=root host={{ item }} password={{ mysql_root_pw }} priv=*.*:ALL,GRANT
  with_items:
    - "%"
    - 127.0.0.1
    - localhost

- name: root's mysql client is updated
  template: src=root_.my.cnf.j2 dest=/root/.my.cnf owner=root group=root mode=0600

- name: anonymous mysql users are absent
  mysql_user: state=absent name= host={{ item }}
  with_items:
    - "{{ ansible_hostname }}"
    - localhost

- name: superfluous root mysql users are absent
  mysql_user: state=absent name=root host={{ item }}
  with_items:
    - "{{ ansible_hostname }}"
    - ::1

- name: mysql test database is absent
  mysql_db: state=absent name=test
